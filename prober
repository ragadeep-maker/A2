#!/usr/bin/env python
import sys,easysnmp,time
from easysnmp import Session

cl_terms = sys.argv
choosen_cl_terms = cl_terms[1]
cl_details = choosen_cl_terms.split(':')
snmp_agent_ip = cl_details[0]
port_number = cl_details[1]
community_type = cl_details[2]
frequency_of_samples = cl_terms[2]
number_of_samples = int(cl_terms[3])
time_of_sampling = 1/float(frequency_of_samples)

oids = []
past_list_oids = []
present_list_oids = []

for k in range(4,len(cl_terms)):
	oids.append(cl_terms[k])
oids.insert(0,'1.3.6.1.2.1.1.3.0')

def prober_snmp():
    global present_list_oids
    global next

    session = Session(hostname=snmp_agent_ip,remote_port=port_number,community=community_type,version=2,timeout=1,retries=1)
    observed_oids = session.get(oids)
    past_list_oids = []

    for k in range(1,len(observed_oids)):
        if observed_oids[k].value!= 'NOSUCHOBJECT' and observed_oids[k].value!='NOSUCHINSTANCE':
            past_list_oids.append(int(observed_oids[k].value))
            if count !=0 and len(present_list_oids)>0:
                calculated_oid = int(past_list_oids[k-1])-int(present_list_oids[k-1])
                overall_time = round(t_start-next,1)
                calculated_rate_oid = int(calculated_oid/overall_time)
                if calculated_rate_oid < 0:
                    if observed_oids[k].snmp_type == 'COUNTER32':
                        calculated_oid = calculated_oid + 2**32
                        print(str(t_start)+"|"+str(calculated_oid/overall_time)+"|")
                    elif observed_oid[k].snmp_type == 'COUNTER64':
                        calculated_oid = calculated_oid + 2**64
                        print(str(t_start)+"|"+str(calculated_oid/overall_time)+"|")
                else:
                    print(str(t_start)+"|"+str(calculated_rate_oid)+"|")
    present_list_oids = past_list_oids
    next = t_start

if int(number_of_samples) == -1:
    count = 0
    present_list_oids = []
    while True:
        t_start = time.time()
        prober_snmp()
        t_end = time.time()
        count = count + 1
        time.sleep(abs(time_of_sampling - t_end + t_start))
else:
    present_list_oids = []
    for count in range (0, number_of_samples+1):
        t_start = time.time()
        prober_snmp()
        t_end = time.time()
        time.sleep(abs(time_of_sampling - t_end + t_start))



